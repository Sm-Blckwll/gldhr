<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Golden Hour</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" />
  <link rel="stylesheet" href="Control.OSMGeocoder.css" />
  <style>
    @import url('./base.css');
  </style>
</head>

<body>
  <div class="crosshairs"></div>
  <div class="top-bar">
    <div class="left-button" id="prev-day" title="Previous day">ðŸ‘ˆ</div>
    <div class="result">
      <div class="emoji-small">ðŸŒ„</div>
      <div class="result-text" id="day"> Golden hour:</div>
      <div class="result-text-output" id="result"></div>
    </div>
    <div class="right-button" id="next-day" title="Next day">ðŸ‘‰</div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
  <script src="Control.OSMGeocoder.js"></script>
  <script src="suncalc.js"></script>
  <script src="geolet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.34/builds/moment-timezone-with-data.min.js"></script>

  <script>
    const mapOptions = {
      minZoom: 4,
      maxZoom: 18,
      center: [54.425, -2.968],
      zoom: 14
    };

    var pin = L.icon({
      iconUrl: 'location-pin-solid.svg',
      iconSize: [19, 47.5],
      iconAnchor: [10, 37.5],
      popupAnchor: [0, -34]
    });

    const map = L.map('map', mapOptions);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
      maxZoom: 18
    }).addTo(map);

    const prevDayButton = document.getElementById("prev-day");
    const nextDayButton = document.getElementById("next-day");
    const date = new Date();

    prevDayButton.addEventListener("click", () => {
      date.setDate(date.getDate() - 1);
      calculateGoldenHour();
    });

    nextDayButton.addEventListener("click", () => {
      date.setDate(date.getDate() + 1);
      calculateGoldenHour();
    });

    function popUpLatLng(e) {
      var ac = e.latlng.lat.toFixed(4);
      var bc = e.latlng.lng.toFixed(4);
      new L.Marker([ac, bc], { icon: pin }).addTo(map)
        .bindPopup(ac + ", " + bc)
        .openPopup();
      map.setView(e.latlng);
      calculateGoldenHour();
    }

    map.on('click', function (e) {
      popUpLatLng(e);
    });

    map.on('moveend', async function () {
      await calculateGoldenHour();
    });

    async function getTimezoneFromCoords(lat, lng) {
      const response = await fetch(`https://timeapi.io/api/TimeZone/coordinate?latitude=${lat}&longitude=${lng}`);
      const data = await response.json();
      return data.timeZone;
    }

    async function calculateGoldenHour() {
      
      document.getElementById('result').innerHTML = 'Waiting for API<span class="loading-text">.</span>';
      
      let c = map.getCenter();
      let lat = parseFloat(c.lat.toFixed(4));
      let lng = parseFloat(c.lng.toFixed(4));

      const timeZone = await getTimezoneFromCoords(lat, lng);

      const times = SunCalc.getTimes(date, lat, lng);
      const sunrise = new Date(times.sunrise);
      const sunset = new Date(times.sunset);

      const goldenHourStartFrom = moment(sunrise).tz(timeZone).format('HH:mm');
      const goldenHourStartTo = moment(sunrise).tz(timeZone).add(1, 'hour').format('HH:mm');
      const goldenHourEndFrom = moment(sunset).tz(timeZone).subtract(1, 'hour').format('HH:mm');
      const goldenHourEndTo = moment(sunset).tz(timeZone).format('HH:mm');

      
      document.getElementById('result').innerHTML = `
        Sunrise: ${goldenHourStartFrom} - ${goldenHourStartTo} &nbsp; // &nbsp;
        Sunset: ${goldenHourEndFrom} - ${goldenHourEndTo}
      `;

      document.getElementById('day').innerHTML = `Golden Hour for ${date.toLocaleDateString('en-GB')} (${timeZone}):`;
    }

    L.geolet({ position: 'bottomleft', className: 'locDot', popupContent: function (latlng) { return 'Your location: ' + latlng.lat + ', ' + latlng.lng; } }).addTo(map);

    var options = {
      collapsed: true,
      position: 'topleft',
      text: '-',
      placeholder: '',
      bounds: null,
      email: null,
      callback: function (results) {
        var bbox = results[0].boundingbox,
          first = new L.LatLng(bbox[0], bbox[2]),
          second = new L.LatLng(bbox[1], bbox[3]),
          bounds = new L.LatLngBounds([first, second]);
        this._map.fitBounds(bounds);
      }
    };

    var osmGeocoder = new L.Control.OSMGeocoder(options);
    map.addControl(osmGeocoder);
  </script>

</body>

</html>
